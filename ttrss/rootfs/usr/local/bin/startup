#!/bin/sh

addgroup -g $"{GID}" web && adduser -H -s /bin/sh -D -G web -u $"{UID}" web

sed -i -e 's/<DOMAIN>/'$DOMAIN'/g' /nginx/sites-enabled/tt-rss.conf

sed -i -e 's/<DB_TYPE>/'"${DB_TYPE}"'/g' \
	-e 's/<DB_HOST>/'"${DB_HOST}"'/g' \
	-e 's/<DB_USER>/'"${DB_USER}"'/g' \
	-e 's/<DB_NAME>/'"${DB_NAME}"'/g' \
	-e 's/<DB_PASS>/'"${DB_PASS}"'/g' \
	-e 's/<DB_PORT>/'"${DB_PORT}"'/g' \
	-e 's#<URL>#'"${URL}"'#g' \
	-e 's/<SINGLE_USER_MODE>/'"${SINGLE_USER_MODE}"'/g' \
	-e 's/<SIMPLE_UPDATE_MODE>/'"${SIMPLE_UPDATE_MODE}"'/g' \
	-e 's/<AUTH_AUTO_CREATE>/'"${AUTH_AUTO_CREATE}"'/g' \
	-e 's/<AUTH_AUTO_LOGIN>/'"${AUTH_AUTO_LOGIN}"'/g' \
	-e 's/<FORCE_ARTICLE_PURGE>/'"${FORCE_ARTICLE_PURGE}"'/g' \
	-e 's/<SPHINX_SERVER>/'"${SPHINX_SERVER}"'/g' \
	-e 's/<SPHINX_INDEX>/'"${SPHINX_INDEX}"'/g' \
	-e 's/<ENABLE_REGISTRATION>/'"${ENABLE_REGISTRATION}"'/g' \
	-e 's/<REG_NOTIFY_ADDRESS>/'"${REG_NOTIFY_ADDRESS}"'/g' \
	-e 's/<REG_MAX_USERS>/'"${REG_MAX_USERS}"'/g' \
	-e 's/<SESSION_COOKIE_LIFETIME>/'"${SESSION_COOKIE_LIFETIME}"'/g' \
	-e 's/<SMTP_FROM_NAME>/'"${SMTP_FROM_NAME}"'/g' \
	-e 's/<SMTP_FROM_ADDRESS>/'"${SMTP_FROM_ADDRESS}"'/g' \
	-e 's/<DIGEST_SUBJECT>/'"${DIGEST_SUBJECT}"'/g' \
	-e 's/<SMTP_SERVER>/'"${SMTP_SERVER}"'/g' \
	-e 's/<SMTP_LOGIN>/'"${SMTP_LOGIN}"'/g' \
	-e 's/<SMTP_PASSWORD>/'"${SMTP_PASSWORD}"'/g' \
	-e 's/<SMTP_SECURE>/'"${SMTP_SECURE}"'/g' \
	-e 's/<CHECK_FOR_UPDATES>/'"${CHECK_FOR_UPDATES}"'/g' \
	-e 's/<ENABLE_GZIP_OUTPUT>/'"${ENABLE_GZIP_OUTPUT}"'/g' \
	-e 's/<PLUGINS>/'"${PLUGINS}"'/g' \
	-e 's/<LOG_DESTINATION>/'"${LOG_DESTINATION}"'/g' \
	-e 's/<CONFIG_VERSION>/'"${CONFIG_VERSION}"'/g'  /tt-rss/config.php

mkdir -p /nginx /php

chown -R web:web /nginx /php /etc/s6.d /tt-rss
chmod +x /etc/s6.d/*/run /etc/s6.d/.s6-svscan/finish

if [ '$@' == '' ]; then
    exec su-exec web:web /bin/s6-svscan /etc/s6.d
else
    exec su-exec web:web "$@"
fi
