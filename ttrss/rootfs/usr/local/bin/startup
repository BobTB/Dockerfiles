#!/bin/sh

addgroup -g ${GID} web && adduser -H -s /bin/sh -D -G web -u ${UID} web

sed -i -e 's/<DOMAIN>/'${DOMAIN}'/g' /nginx/sites-enabled/tt-rss.conf

    echo 1 && sed -i -e 's/<DB_TYPE>/'${DB_TYPE}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<DB_HOST>/'${DB_HOST}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<DB_USER>/'${DB_USER}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<DB_NAME>/'${DB_NAME}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<DB_PASS>/'${DB_PASS}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<DB_PORT>/'${DB_PORT}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's|<URL>|'"${URL}"'|g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SINGLE_USER_MODE>/'${SINGLE_USER_MODE}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SIMPLE_UPDATE_MODE>/'${SIMPLE_UPDATE_MODE}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<AUTH_AUTO_CREATE>/'${AUTH_AUTO_CREATE}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<AUTH_AUTO_LOGIN>/'${AUTH_AUTO_LOGIN}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<FORCE_ARTICLE_PURGE>/'${FORCE_ARTICLE_PURGE}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SPHINX_SERVER>/'${SPHINX_SERVER}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SPHINX_INDEX>/'"${SPHINX_INDEX}"'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<ENABLE_REGISTRATION>/'${ENABLE_REGISTRATION}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<REG_NOTIFY_ADDRESS>/'${REG_NOTIFY_ADDRESS}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<REG_MAX_USERS>/'${REG_MAX_USERS}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SESSION_COOKIE_LIFETIME>/'${SESSION_COOKIE_LIFETIME}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SMTP_FROM_NAME>/'"${SMTP_FROM_NAME}"'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SMTP_FROM_ADDRESS>/'"${SMTP_FROM_ADDRESS}"'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<DIGEST_SUBJECT>/'"${DIGEST_SUBJECT}"'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SMTP_SERVER>/'${SMTP_SERVER}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SMTP_LOGIN>/'${SMTP_LOGIN}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SMTP_PASSWORD>/'"${SMTP_PASSWORD}"'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<SMTP_SECURE>/'${SMTP_SECURE}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<CHECK_FOR_UPDATES>/'${CHECK_FOR_UPDATES}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<ENABLE_GZIP_OUTPUT>/'${ENABLE_GZIP_OUTPUT}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<PLUGINS>/'"${PLUGINS}"'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<LOG_DESTINATION>/'${LOG_DESTINATION}'/g' /tt-rss/config.php
	echo 1 && sed -i -e 's/<CONFIG_VERSION>/'${CONFIG_VERSION}'/g'  /tt-rss/config.php

mkdir -p /nginx /php

chown -R web:web /nginx /php /etc/s6.d /tt-rss
chmod +x /etc/s6.d/*/run /etc/s6.d/.s6-svscan/finish

if [ '$@' == '' ]; then
    exec su-exec web:web /bin/s6-svscan /etc/s6.d
else
    exec su-exec web:web "$@"
fi
