#!/bin/sh

addgroup -g ${GID} web && adduser -H -s /bin/sh -D -G web -u ${UID} web

mkdir -p /nginx /php

APP_KEY=${APP_KEY:-null}
APP_ENV=${APP_ENV:-development}
APP_DEBUG=${APP_DEBUG:-true}
APP_URL=${APP_URL:-http://localhost}
APP_LOG=${APP_LOG:-errorlog}

DB_DRIVER=${DB_DRIVER:-pgsql}
DB_HOST=${DB_HOST:-postgres}
DB_DATABASE=${DB_DATABASE:-cachet}
DB_PREFIX=${DB_PREFIX}
DB_USERNAME=${DB_USERNAME:-postgres}
DB_PASSWORD=${DB_PASSWORD:-postgres}

if [[ "${DB_DRIVER}" = "pgsql" ]]; then
DB_PORT=${DB_PORT:-5432}
fi

if [[ "${DB_DRIVER}" = "mysql" ]]; then
DB_PORT=${DB_PORT:-3306}
fi

DB_PORT=${DB_PORT}

CACHE_DRIVER=${CACHE_DRIVER:-apc}

SESSION_DRIVER=${SESSION_DRIVER:-cookie}
SESSION_DOMAIN=${SESSION_DOMAIN:-$APP_URL}
SESSION_SECURE_COOKIE=${SESSION_SECURE_COOKIE:-false}

QUEUE_DRIVER=${QUEUE_DRIVER:-database}
CACHET_EMOJI=${CACHET_EMOJI:-false}
CACHET_BEACON=${CACHET_BEACON:-true}
CACHET_AUTO_TWITTER=${CACHET_AUTO_TWITTER:-true}

MAIL_DRIVER=${MAIL_DRIVER:-smtp}
MAIL_HOST=${MAIL_HOST:-localhost}
MAIL_PORT=${MAIL_PORT:-25}
MAIL_USERNAME=${MAIL_USERNAME:-null}
MAIL_PASSWORD=${MAIL_PASSWORD:-null}
MAIL_ADDRESS=${MAIL_ADDRESS:-null}
MAIL_NAME=${MAIL_NAME:-null}
MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-null}

REDIS_HOST=${REDIS_HOST:-null}
REDIS_DATABASE=${REDIS_DATABASE:-null}
REDIS_PORT=${REDIS_PORT:-null}
REDIS_PASSWORD=${REDIS_PASSWORD:-null}

GITHUB_TOKEN=${GITHUB_TOKEN:-null}

NEXMO_KEY=${NEXMO_KEY:-null}
NEXMO_SECRET=${NEXMO_SECRET:-null}
NEXMO_SMS_FROM=${NEXMO_SMS_FROM:-Cachet}

PHP_MAX_CHILDREN=${PHP_MAX_CHILDREN:-5}

# configure env file

sed 's,{{APP_ENV}},'${APP_ENV}',g' -i /cachetHQ/.env
sed 's,{{APP_DEBUG}},'${APP_DEBUG}',g' -i /cachetHQ/.env
sed 's,{{APP_URL}},'${APP_URL}',g' -i /cachetHQ/.env
sed 's,{{APP_LOG}},'${APP_LOG}',g' -i /cachetHQ/.env

sed 's,{{DB_DRIVER}},'${DB_DRIVER}',g' -i /cachetHQ/.env
sed 's,{{DB_HOST}},'${DB_HOST}',g' -i /cachetHQ/.env
sed 's,{{DB_DATABASE}},'${DB_DATABASE}',g' -i /cachetHQ/.env
sed 's,{{DB_PREFIX}},'${DB_PREFIX}',g' -i /cachetHQ/.env
sed 's,{{DB_USERNAME}},'${DB_USERNAME}',g' -i /cachetHQ/.env
sed 's,{{DB_PASSWORD}},'${DB_PASSWORD}',g' -i /cachetHQ/.env
sed 's,{{DB_PORT}},'${DB_PORT}',g' -i /cachetHQ/.env

sed 's,{{CACHE_DRIVER}},'${CACHE_DRIVER}',g' -i /cachetHQ/.env

sed 's,{{SESSION_DRIVER}},'${SESSION_DRIVER}',g' -i /cachetHQ/.env
sed 's,{{SESSION_DOMAIN}},'${SESSION_DOMAIN}',g' -i /cachetHQ/.env
sed 's,{{SESSION_SECURE_COOKIE}},'${SESSION_SECURE_COOKIE}',g' -i /cachetHQ/.env

sed 's,{{QUEUE_DRIVER}},'${QUEUE_DRIVER}',g' -i /cachetHQ/.env
sed 's,{{CACHET_EMOJI}},'${CACHET_EMOJI}',g' -i /cachetHQ/.env
sed 's,{{CACHET_BEACON}},'${CACHET_BEACON}',g' -i /cachetHQ/.env
sed 's,{{CACHET_AUTO_TWITTER}},'${CACHET_AUTO_TWITTER}',g' -i /cachetHQ/.env

sed 's,{{MAIL_DRIVER}},'${MAIL_DRIVER}',g' -i /cachetHQ/.env
sed 's,{{MAIL_HOST}},'${MAIL_HOST}',g' -i /cachetHQ/.env
sed 's,{{MAIL_PORT}},'${MAIL_PORT}',g' -i /cachetHQ/.env
sed 's,{{MAIL_USERNAME}},'${MAIL_USERNAME}',g' -i /cachetHQ/.env
sed 's,{{MAIL_PASSWORD}},'${MAIL_PASSWORD}',g' -i /cachetHQ/.env
sed 's,{{MAIL_ADDRESS}},'${MAIL_ADDRESS}',g' -i /cachetHQ/.env
sed 's,{{MAIL_NAME}},'${MAIL_NAME}',g' -i /cachetHQ/.env
sed 's,{{MAIL_ENCRYPTION}},'${MAIL_ENCRYPTION}',g' -i /cachetHQ/.env

sed 's,{{REDIS_HOST}},'${REDIS_HOST}',g' -i /cachetHQ/.env
sed 's,{{REDIS_DATABASE}},'${REDIS_DATABASE}',g' -i /cachetHQ/.env
sed 's,{{REDIS_PORT}},'${REDIS_PORT}',g' -i /cachetHQ/.env
sed 's,{{REDIS_PASSWORD}},'${REDIS_PASSWORD}',g' -i /cachetHQ/.env
sed 's,{{GITHUB_TOKEN}},'${GITHUB_TOKEN}',g' -i /cachetHQ/.env
sed 's,{{NEXMO_KEY}},'${NEXMO_KEY}',g' -i /cachetHQ/.env
sed 's,{{NEXMO_SECRET}},'${NEXMO_SECRET}',g' -i /cachetHQ/.env
sed 's,{{NEXMO_SMS_FROM}},'${NEXMO_SMS_FROM}',g' -i /cachetHQ/.env

php artisan app:install	

chown -R web:web /nginx /php /etc/s6.d
chmod +x /etc/s6.d/*/run /etc/s6.d/.s6-svscan/finish

if [ '$@' == '' ]; then
    exec su-exec web:web /bin/s6-svscan /etc/s6.d
else
    exec su-exec web:web "$@"
fi