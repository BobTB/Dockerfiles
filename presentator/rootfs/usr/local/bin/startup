#!/bin/sh

addgroup -g ${GID} web && adduser -H -s /bin/sh -D -G web -u ${UID} web

mkdir -p /nginx /php

chown -R web:web /nginx /php /etc/s6.d

sed -i -e "s/<PUBLIC_URL>/$PUBLIC_URL/g" /presentator/common/config/params-local.php /nginx/sites-enabled/api.presentator.conf \
	   -e "s/<SALT>/$SALT/g" /presentator/common/config/params-local.php \
	   -e "s/<API_SALT>/$API_SALT/g" /presentator/common/config/params-local.php \
	   -e "s/<RECAPTCHA_KEY>/$RECAPTCHA_KEY/g" /presentator/common/config/params-local.php \ 
	   -e "s/<RECAPTCHA_SECRET>/$RECAPTCHA_SECRET/g" /presentator/common/config/params-local.php \
	   -e "s/<NOREPLY_MAIL>/$NOREPLY_MAIL/g" /presentator/common/config/params-local.php \
	   -e "s/<SUPPORT_MAIL>/$SUPPORT_MAIL/g" /presentator/common/config/params-local.php 
	  
sed -i -e "s/<DB_HOST>/$DB_HOST/g" /presentator/common/config/main-local.php \
	   -e "s/<DB_NAME>/$DB_NAME/g" /presentator/common/config/main-local.php \
	   -e "s/<DB_USERNAME>/$DB_USERNAME/g" /presentator/common/config/main-local.php \
	   -e "s/<DB_PASSWORD>/$DB_PASSWORD/g" /presentator/common/config/main-local.php \
	   -e "s/<SMTP_HOST>/$SMTP_HOST/g" /presentator/common/config/main-local.php \
	   -e "s/<SMTP_USERNAME>/$SMTP_USERNAME/g" /presentator/common/config/main-local.php \
	   -e "s#<SMTP_PASSWORD>#$SMTP_PASSWORD#g" /presentator/common/config/main-local.php \
	   -e "s/<SMTP_PORT>/$SMTP_PORT/g" /presentator/common/config/main-local.php 

sed -i -e "s/<API_URI>/$API_URI/g" /nginx/sites-enabled/api.presentator.conf

php /presentator/yii migrate

if [ '$@' == '' ]; then
    exec su-exec web:web /bin/s6-svscan /etc/s6.d
else
    exec su-exec web:web "$@"
fi
